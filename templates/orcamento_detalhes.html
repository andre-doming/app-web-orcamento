{% extends "base.html" %}

{% block scripts %}
<script>
function editarQuantidade(itemId, quantidadeAtual) {
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editQuantidade').value = quantidadeAtual;
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

function salvarEdicao() {
    const itemId = document.getElementById('editItemId').value;
    const quantidade = parseFloat(document.getElementById('editQuantidade').value);
    const csrfToken = document.getElementById('csrf_token').value;
    const messageDiv = document.getElementById('editMessage');

    // Limpar mensagens anteriores
    messageDiv.innerHTML = '';
    messageDiv.className = 'mt-3';

    if (!quantidade || quantidade <= 0) {
        messageDiv.innerHTML = '<div class="alert alert-danger">Quantidade deve ser maior que zero.</div>';
        return;
    }

    fetch(`/orcamento/item/${itemId}/editar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ quantidade: quantidade })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            messageDiv.innerHTML = '<div class="alert alert-danger">Erro ao atualizar quantidade: ' + data.message + '</div>';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        messageDiv.innerHTML = '<div class="alert alert-danger">Erro ao atualizar quantidade.</div>';
    });
}
</script>
{% endblock %}

{% block content %}
<input type="hidden" id="csrf_token" value="{{ csrf_token() }}"/>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Orçamento #{{ orcamento.id }}</h1>
    <div>
        {% if not orcamento.aprovado %}
        <a href="{{ url_for('main.orcamento_editar', id=orcamento.id) }}" class="btn btn-warning">Editar</a>
        <a href="{{ url_for('main.orcamento_deletar', id=orcamento.id) }}" class="btn btn-danger" onclick="return confirm('Tem certeza?')">Deletar</a>
        <a href="{{ url_for('main.orcamento_aprovar', id=orcamento.id) }}" class="btn btn-success" onclick="return confirm('Aprovar orçamento?')">Aprovar</a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Informações Gerais</h5>
            </div>
            <div class="card-body">
                <p><strong>Cliente:</strong> {{ orcamento.cliente.nome }}</p>
                <p><strong>Endereço:</strong> {{ orcamento.endereco.logradouro }}, {{ orcamento.endereco.numero }}{% if orcamento.endereco.complemento %} - {{ orcamento.endereco.complemento }}{% endif %} - {{ orcamento.endereco.cidade }}/{{ orcamento.endereco.estado }}</p>
                <p><strong>Data Orçamento:</strong> {{ orcamento.data_orcamento.strftime('%d/%m/%Y') }}</p>
                <p><strong>Data Validade:</strong> {{ orcamento.data_validade.strftime('%d/%m/%Y') }}</p>
                <p><strong>Status:</strong> 
                    {% if orcamento.aprovado %}
                        <span class="badge bg-success">Aprovado</span>
                    {% else %}
                        <span class="badge bg-warning">Pendente</span>
                    {% endif %}
                </p>
                <p><strong>Valor Total:</strong> R$ {{ "%.2f"|format(orcamento.valor_total) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        {% if not orcamento.aprovado %}
        <div class="card">
            <div class="card-header">
                <h5>Adicionar Item</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.orcamento_item_adicionar', orcamento_id=orcamento.id) }}">
                    {{ item_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ item_form.item_id.label(class="form-label") }}
                        {{ item_form.item_id(class="form-select") }}
                    </div>
                    <div class="mb-3">
                        {{ item_form.quantidade.label(class="form-label") }}
                        {{ item_form.quantidade(class="form-control") }}
                    </div>
                    {{ item_form.submit(class="btn btn-primary") }}
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Itens do Orçamento</h5>
            </div>
            <div class="card-body">
                {% if orcamento.itens %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantidade</th>
                                <th>Valor Unitário</th>
                                <th>Valor Total</th>
                                {% if not orcamento.aprovado %}
                                <th>Ações</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in orcamento.itens %}
                            <tr>
                                <td>{{ item.item.nome }}</td>
                                <td>{{ item.quantidade }}</td>
                                <td>R$ {{ "%.2f"|format(item.valor_unitario) }}</td>
                                <td>R$ {{ "%.2f"|format(item.valor_total) }}</td>
                                {% if not orcamento.aprovado %}
                                <td>
                                    <a href="#" class="btn btn-sm btn-warning me-1" onclick="editarQuantidade({{ item.id }}, {{ item.quantidade }})">Editar</a>
                                    <a href="{{ url_for('main.orcamento_item_remover', orcamento_id=orcamento.id, item_id=item.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Remover item?')">Remover</a>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>Nenhum item adicionado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar quantidade -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Quantidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <input type="hidden" id="editItemId">
                    <div class="mb-3">
                        <label for="editQuantidade" class="form-label">Quantidade</label>
                        <input type="number" class="form-control" id="editQuantidade" min="0.01" step="0.01" required>
                    </div>
                </form>
                <div id="editMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
